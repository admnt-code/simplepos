"""
Vereins-Kassensystem - Core Configuration
Datei: backend/app/core/config.py

Zentrale Konfiguration der Anwendung mit Pydantic Settings.
"""

from typing import List, Optional
from pydantic import Field, validator
from pydantic_settings import BaseSettings
import secrets


class Settings(BaseSettings):
    """
    Hauptkonfigurationsklasse mit Environment Variables
    """
    
    model_config = {
        "case_sensitive": True,
        "env_file": ".env",
        "env_file_encoding": "utf-8",
        "str_strip_whitespace": True,
    }
    
    # =================================
    # Application Settings
    # =================================
    APP_NAME: str = "Vereinskasse"
    APP_VERSION: str = "1.0.0"
    APP_ENV: str = "production"
    DEBUG: bool = False
    LOG_LEVEL: str = "INFO"
    
    # =================================
    # Server Settings
    # =================================
    HOST: str = "0.0.0.0"
    PORT: int = 8000
    WORKERS: int = 4
    RELOAD: bool = False
    
    # =================================
    # Database Settings
    # =================================
    POSTGRES_USER: str
    POSTGRES_PASSWORD: str
    POSTGRES_DB: str
    POSTGRES_HOST: str = "postgres"
    POSTGRES_PORT: int = 5432
    DATABASE_URL: Optional[str] = None
    
    @validator("DATABASE_URL", pre=True)
    def assemble_db_connection(cls, v: Optional[str], values: dict) -> str:
        """
        Erstellt DATABASE_URL wenn nicht explizit gesetzt
        """
        if isinstance(v, str):
            return v
        return (
            f"postgresql+asyncpg://{values.get('POSTGRES_USER')}:"
            f"{values.get('POSTGRES_PASSWORD')}@"
            f"{values.get('POSTGRES_HOST')}:"
            f"{values.get('POSTGRES_PORT')}/"
            f"{values.get('POSTGRES_DB')}"
        )
    
    # =================================
    # Security Settings
    # =================================
    SECRET_KEY: str = Field(default_factory=lambda: secrets.token_urlsafe(32))
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    REFRESH_TOKEN_EXPIRE_DAYS: int = 7
    
    # =================================
    # CORS Settings
    # =================================
    CORS_ORIGINS: List[str] = [
        "http://localhost:3000",
        "http://localhost:5173"
    ]
    CORS_ALLOW_CREDENTIALS: bool = True
    CORS_ALLOW_METHODS: List[str] = ["*"]
    CORS_ALLOW_HEADERS: List[str] = ["*"]
    
    @validator("CORS_ORIGINS", pre=True)
    def assemble_cors_origins(cls, v: str | List[str]) -> List[str]:
        """
        Konvertiert CORS_ORIGINS string zu Liste
        """
        if isinstance(v, str):
            return [i.strip() for i in v.split(",")]
        return v
    
    # =================================
    # SumUp Settings
    # =================================
    SUMUP_API_KEY: str
    SUMUP_MERCHANT_CODE: str
    SUMUP_AFFILIATE_KEY: str
    SUMUP_READER_ID: Optional[str] = None
    SUMUP_MODE: str = "cloud_api"  # cloud_api oder payment_link
    SUMUP_API_BASE_URL: str = "https://api.sumup.com/v0.1"
    SUMUP_POLLING_INTERVAL: int = 3  # Sekunden
    SUMUP_POLLING_TIMEOUT: int = 120  # Sekunden
    
    @validator("SUMUP_MODE")
    def validate_sumup_mode(cls, v: str) -> str:
        """
        Validiert SumUp Modus
        """
        allowed_modes = ["cloud_api", "payment_link"]
        if v not in allowed_modes:
            raise ValueError(f"SUMUP_MODE must be one of {allowed_modes}")
        return v
    
    # =================================
    # Payment Settings
    # =================================
    MEMBER_CREDIT_LIMIT: float = -15.00
    DEFAULT_CURRENCY: str = "EUR"
    MEMBER_FEE_RATE: float = 0.0139  # 1.39%
    PAYMENT_LINK_FEE_RATE: float = 0.025  # 2.5%
    
    # =================================
    # Tax Settings
    # =================================
    DEFAULT_TAX_RATE_FOOD: float = 0.07  # 7%
    DEFAULT_TAX_RATE_DRINKS: float = 0.19  # 19%
    MEMBER_TAX_EXEMPT: bool = True
    
    # =================================
    # File Upload Settings
    # =================================
    MAX_UPLOAD_SIZE: int = 10485760  # 10MB
    UPLOAD_DIR: str = "./uploads"
    ALLOWED_EXTENSIONS: List[str] = ["jpg", "jpeg", "png", "pdf"]
    
    @validator("ALLOWED_EXTENSIONS", pre=True)
    def assemble_allowed_extensions(cls, v: str | List[str]) -> List[str]:
        """
        Konvertiert ALLOWED_EXTENSIONS string zu Liste
        """
        if isinstance(v, str):
            return [i.strip() for i in v.split(",")]
        return v
    
    # =================================
    # Backup Settings
    # =================================
    BACKUP_DIR: str = "./backups"
    BACKUP_RETENTION_DAYS: int = 60
    DB_BACKUP_SCHEDULE: str = "0 2 * * *"
    FULL_BACKUP_SCHEDULE: str = "0 3 * * 0"
    
    # =================================
    # RFID Settings
    # =================================
    RFID_ENABLED: bool = True
    RFID_READER_TYPE: str = "USB"  # USB, SERIAL, NETWORK
    RFID_DEVICE_PATH: str = "/dev/ttyUSB0"
    
    # =================================
    # Email Settings
    # =================================
    SMTP_ENABLED: bool = False
    SMTP_HOST: Optional[str] = None
    SMTP_PORT: int = 587
    SMTP_USER: Optional[str] = None
    SMTP_PASSWORD: Optional[str] = None
    SMTP_FROM: Optional[str] = None
    
    # =================================
    # Redis Settings
    # =================================
    REDIS_ENABLED: bool = False
    REDIS_HOST: str = "redis"
    REDIS_PORT: int = 6379
    REDIS_DB: int = 0
    REDIS_PASSWORD: Optional[str] = None
    
    # =================================
    # Monitoring & Logging
    # =================================
    SENTRY_DSN: Optional[str] = None
    LOG_FILE: str = "./logs/backend/app.log"
    LOG_MAX_BYTES: int = 10485760  # 10MB
    LOG_BACKUP_COUNT: int = 5
    
    # =================================
    # Feature Flags
    # =================================
    FEATURE_GUEST_SUMUP_PAYMENT: bool = True
    FEATURE_MEMBER_TRANSFER: bool = True
    FEATURE_PRODUCT_VARIANTS: bool = True
    FEATURE_MULTI_LANGUAGE: bool = True
    FEATURE_EXPORT_EXCEL: bool = True
    FEATURE_EXPORT_PDF: bool = True
    
    # =================================
    # Locale Settings
    # =================================
    DEFAULT_LANGUAGE: str = "de"
    SUPPORTED_LANGUAGES: List[str] = ["de", "en"]
    TIMEZONE: str = "Europe/Berlin"
    
    @validator("SUPPORTED_LANGUAGES", pre=True)
    def assemble_supported_languages(cls, v: str | List[str]) -> List[str]:
        """
        Konvertiert SUPPORTED_LANGUAGES string zu Liste
        """
        if isinstance(v, str):
            return [i.strip() for i in v.split(",")]
        return v
    
    # =================================
    # Rate Limiting
    # =================================
    RATE_LIMIT_ENABLED: bool = True
    RATE_LIMIT_PER_MINUTE: int = 60
    RATE_LIMIT_BURST: int = 10
    
    # =================================
    # Computed Properties
    # =================================
    @property
    def is_development(self) -> bool:
        """Prüft ob Development Environment"""
        return self.APP_ENV == "development"
    
    @property
    def is_production(self) -> bool:
        """Prüft ob Production Environment"""
        return self.APP_ENV == "production"
    
    @property
    def database_url_sync(self) -> str:
        """
        Synchrone Database URL für Alembic
        """
        return self.DATABASE_URL.replace(
            "postgresql+asyncpg://",
            "postgresql://"
        )


# Singleton Instance
settings = Settings()
